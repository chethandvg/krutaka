---
applyTo: "src/Krutaka.Core/Orchestration/**,src/Krutaka.Tools/Session/**"
---

# v0.5.0 Orchestration and Session — Coding Instructions

These instructions apply when modifying files under `src/Krutaka.Core/Orchestration/` or `src/Krutaka.Tools/Session/`. Read `docs/versions/v0.5.0.md` before making any changes in these directories.

## Orchestrator Modification Rules

- `AgentOrchestrator` MUST use `partial class` split across focused files:
  - `AgentOrchestrator.cs` — core constructor, fields, and `RunAsync` entry point
  - `AgentOrchestrator.ToolCallLoop.cs` — per-tool-call pipeline (budget → autonomy → anomaly → checkpoint → execute → update)
  - `AgentOrchestrator.StateMachine.cs` — `AgentState` transitions (`Running ↔ Paused → Aborted`)
  - Additional partials as needed when any file exceeds 300 lines
- All v0.5.0 subsystem dependencies (`ITaskBudgetTracker`, `IGitCheckpointService`, `IBehaviorAnomalyDetector`) are **optional** constructor parameters — use null-safe patterns so the orchestrator functions correctly when they are absent (e.g., during unit tests or at Level 0/1 if a subsystem is disabled)
- Do NOT modify existing constructor signatures; add new overloads or use `IOptions<>` patterns

## Per-Session Component Lifecycle Rules

The following components MUST be created per-session by `ISessionFactory` and MUST NEVER be registered as singletons:

- `ITaskBudgetTracker` — tracks token/tool/file/process budgets for a single session
- `IGitCheckpointService` — manages git checkpoints scoped to a single working directory
- `IBehaviorAnomalyDetector` — monitors behavioral metrics for a single agent session
- `DeadmanSwitch` — timer that lives in `SessionManager`, NOT in the orchestrator

Shared (singleton-safe) services remain unchanged: `IClaudeClient`, `ISecurityPolicy`, `IAuditLogger`, `IAccessPolicyEngine`, `ICommandRiskClassifier`.

## Tool Call Loop Integration Points

Each tool call in the agentic loop MUST follow this exact sequence:

1. **Budget check** — call `ITaskBudgetTracker.TryConsumeAsync()`. If `BudgetExhausted`, yield `BudgetExhausted` event and stop the loop. At 80% warn via `BudgetWarning` event.
2. **Autonomy check** — compare tool risk tier against `AutonomyLevel` from config. Auto-approve or prompt accordingly. Autonomy level is read-only from config at this point — NEVER modified here.
3. **Anomaly check** — call `IBehaviorAnomalyDetector.AssessAsync()` with the current `AgentBehaviorSnapshot`. If `IsAnomalous` at Level 2+, yield `AnomalyDetected` event and transition to `Paused`.
4. **Checkpoint creation** — if the tool modifies files and git is available, call `IGitCheckpointService.CreateCheckpointAsync()` before execution.
5. **Tool execution** — execute the tool via the existing `IToolRegistry` pipeline.
6. **Budget update** — record actual token/resource consumption after execution completes.

## Agent State Machine Transition Rules

Valid transitions for `AgentState`:

| From | To | Trigger |
|------|----|---------|
| `Running` | `Paused` | `/pause` command, `AnomalyDetected` event, deadman switch timeout |
| `Paused` | `Running` | `/continue` command, user heartbeat |
| `Running` | `Aborted` | `/abort` command, double deadman timeout |
| `Paused` | `Aborted` | `/abort` command, double deadman timeout |

Rules:
- `Aborted` is **terminal** — no transitions out of `Aborted`
- State transitions MUST be logged via `IAuditLogger` with timestamp and trigger
- State is per-session; NEVER shared between sessions
- The orchestrator checks `AgentState` at the top of each loop iteration — a `Paused` state blocks the next tool call until the state returns to `Running`
- A minimum of 1 second must elapse between `/pause` and `/continue` (debounce) to prevent rapid cycling (AT10 mitigation)

## Security Invariants (Enforced Here)

- **S9:** `AutonomyLevel` MUST be read from config at session start and stored as an immutable value. No code path in the orchestrator or tool loop may modify it at runtime.
- **S10:** `ITaskBudgetTracker` budget caps MUST only increase in response to an explicit user action (e.g., `/extend`). The orchestrator and tool loop MUST NOT call any budget-increase API.
- **S13:** `IBehaviorAnomalyDetector` thresholds are loaded from config at session start. The orchestrator MUST NOT expose any method to modify thresholds at runtime.
- **S15:** Content passed to `/steer` MUST be wrapped in `<untrusted_content>` tags before injection into the conversation.
