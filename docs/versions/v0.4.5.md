# Krutaka v0.4.5 â€” Session Resilience, API Hardening & Context Intelligence

> **Status:** âœ… Complete (2026-02-19)
> **Predecessor:** v0.4.0 (Telegram Integration & Multi-Session Architecture)
> **Epic Issue:** #177
> **Final Test Count:** 1,917 tests passing (2 skipped)

## Overview

v0.4.5 is a **stability, resilience, and intelligence** release that addresses real-world failure modes discovered during v0.3.0+ usage and identified through OpenClaw gap analysis. It focuses on three pillars:

1. **Session Resilience**: Fix the orphaned `tool_use` crash on session resume, improve `RepairOrphanedToolUseBlocks`, and add compaction event tracking
2. **API Hardening**: Add retry/backoff for Anthropic rate limits, graceful error recovery in the main loop, and directory-awareness in system prompts
3. **Context Intelligence**: Pre-compaction memory flush, tool result pruning for older turns, and bootstrap file size caps to control system prompt bloat

This release does NOT introduce new user-facing features â€” it makes the existing features dramatically more reliable.

## Motivation â€” Real-World Failures

### Failure 1: Session Resume Crash (Console Output Analysis)

```
AnthropicBadRequestException: messages.17: `tool_use` ids were found without
`tool_result` blocks immediately after: toolu_01LMKwwxsFvi7EubytwkNWEA
```

**Root cause chain:**
1. User auto-resumed session with 37 messages
2. `SessionStore.ReconstructMessagesAsync()` called `RepairOrphanedToolUseBlocks()`
3. Repair logic failed to detect the orphaned `tool_use` in message 17 (likely due to `toolCall.Input` being stored as a string that gets double-serialized during round-trip)
4. `AgentOrchestrator.CompactIfNeededAsync()` called `ClaudeClientWrapper.CountTokensAsync()` with the malformed history
5. Claude API returned 400 BadRequest
6. No try-catch around `CompactIfNeededAsync()` â†’ unhandled exception crashed the main loop
7. User lost the session and had to start over with `/new`

### Failure 2: Working Directory Confusion (Console Output Analysis)

The agent attempted 8+ iterations trying to write files with `write_file` tool, each time getting "Access denied" because:
- Claude didn't know the `CeilingDirectory` or `DefaultWorkingDirectory` paths
- The system prompt contains no directory information
- Claude tried relative paths, absolute paths, and various guesses â€” all failed
- User eventually had to manually copy the code output

### Failure 3: Rate Limit (Identified in Outline_gaps.md)

Anthropic's rate limits (RPM, ITPM, OTPM) return 429 with `retry-after` header. The current `ClaudeClientWrapper` has zero retry logic for rate limits â€” a single 429 crashes the agentic loop.

### Failure 4: Context Loss During Compaction (OpenClaw Gap Analysis)

When compaction triggers, critical decisions and file paths from earlier in the conversation are lost because:
- No memory flush happens before compaction
- The summarization prompt preserves some context, but important nuances (user preferences, architectural decisions, partial progress) are dropped
- OpenClaw addresses this with a "pre-compaction memory flush" that writes key decisions to MEMORY.md

### Failure 5: Token Budget Waste (OpenClaw Gap Analysis)

Large tool results from older turns (e.g., a 50KB file read 10 turns ago) remain in the conversation history at full size, consuming tokens unnecessarily. OpenClaw trims these to `[Previous tool result truncated â€” 51,200 chars]` after N turns.

## Goals

- **Fix session resume crash**: Harden `RepairOrphanedToolUseBlocks`, normalize `tool_use` input serialization, add post-repair validation
- **Add API retry/backoff**: Exponential backoff with jitter for rate limits in `ClaudeClientWrapper`
- **Add error recovery**: Graceful handling of `AnthropicBadRequestException` in main loop â€” offer session repair or `/new`
- **Add directory awareness to system prompt**: Include `DefaultWorkingDirectory`, `CeilingDirectory`, and `AutoGrantPatterns` in `SystemPromptBuilder` output
- **Add pre-compaction memory flush**: Write critical context to MEMORY.md before compaction triggers
- **Add tool result pruning**: Trim large tool results from older turns before sending to Claude API
- **Add bootstrap file caps**: Limit per-file and total character counts in system prompt bootstrap files
- **Add compaction events to JSONL**: Record compaction metadata in session files for debugging

## Non-Goals

- New tools or tool modifications (existing tools unchanged)
- New user-facing commands (no new `/` commands)
- Telegram-specific features (v0.4.5 improvements apply to both Console and Telegram)
- Interactive working directory prompt (deferred â€” requires Program.cs startup restructuring)
- Telegram setup wizard (deferred â€” requires new setup infrastructure)
- Vector search or Memory v2 (deferred per ADR-009)
- Changes to command risk classification (v0.3.0 â€” consumed as-is)

## Immutable Security Boundaries (NEVER change)

All v0.1.0â€“v0.4.0 boundaries remain. No new boundaries introduced.
- Session repair MUST NOT fabricate tool results that could influence Claude's behavior â€” synthetic results MUST be marked `is_error = true`
- Tool result pruning MUST NOT modify persisted JSONL â€” only in-memory messages sent to Claude API
- Pre-compaction memory flush MUST wrap conversation content in `<untrusted_content>` tags (existing pattern)
- Bootstrap file caps MUST NOT silently drop security-critical content (Layer 2 security instructions are hardcoded, never truncated)

## Architecture

### Session Resume Fix

```
SessionStore.ReconstructMessagesAsync()
  â†’ ParseToolInput() ensures JsonElement (not string) for tool_use.input
  â†’ RepairOrphanedToolUseBlocks() detects orphaned IDs via set difference
  â†’ NEW: PostRepairValidation() re-scans to verify invariant holds
  â†’ Returns validated message list

AgentOrchestrator.CompactIfNeededAsync()
  â†’ NEW: try-catch wrapper â€” on failure, logs error and skips compaction
  â†’ Never crashes the agentic loop
```

### API Retry/Backoff

```
ClaudeClientWrapper
  â†’ SendMessageAsync(): catch AnthropicRateLimitException â†’ retry with backoff
  â†’ CountTokensAsync(): catch AnthropicRateLimitException â†’ retry with backoff
  â†’ Backoff strategy: 1s, 2s, 4s, 8s (max 30s, max 3 retries)
  â†’ Parse retry-after header if available
  â†’ Jitter: Â±25% randomization to prevent thundering herd
```

### Directory Awareness in System Prompt

```
SystemPromptBuilder.BuildAsync()
  â†’ Layer 3c (NEW): Environment Context
  â†’ Includes: DefaultWorkingDirectory, CeilingDirectory, AutoGrantPatterns
  â†’ Injected via ToolOptions (already available in DI)
  â†’ Claude knows exactly where it can write files
```

### Pre-Compaction Memory Flush

```
ContextCompactor.CompactAsync()
  â†’ NEW: Before summarization, generate a "memory flush" prompt
  â†’ Asks Claude to extract: key decisions, file paths, user preferences, progress
  â†’ Writes extracted context to MEMORY.md via MemoryFileService
  â†’ Then proceeds with normal compaction
  â†’ Console: brief "ðŸ“ Saving context..." indicator
  â†’ Telegram: silent (no user message)
```

### Tool Result Pruning

```
AgentOrchestrator.RunAgenticLoopAsync()
  â†’ Before each SendMessageAsync() call
  â†’ NEW: PruneOldToolResults(conversationSnapshot)
  â†’ For tool_result blocks older than N turns (configurable, default: 6):
    â†’ If content length > threshold (default: 1000 chars):
      â†’ Replace with: "[Previous tool result truncated â€” {X} chars. Use read_file to re-read if needed.]"
  â†’ Does NOT modify _conversationHistory (only the snapshot sent to Claude)
  â†’ Does NOT modify JSONL (permanent history intact)
```

### Bootstrap File Caps

```
SystemPromptBuilder.LoadCoreIdentityAsync()
  â†’ NEW: Cap at MaxBootstrapCharsPerFile (default: 20,000)
  â†’ NEW: Total cap across all files: MaxBootstrapTotalChars (default: 150,000)
  â†’ Truncation marker: "[... truncated at 20,000 chars. Use read_file for full content ...]"
  â†’ Layer 2 (Security Instructions) is hardcoded â€” NEVER truncated
```

### Compaction Events in JSONL

```
SessionStore
  â†’ NEW event type: "compaction"
  â†’ Written after CompactAsync() completes
  â†’ Contains: summary, tokensBefore, tokensAfter, messagesRemoved, timestamp
  â†’ LoadAsync() skips compaction events during message reconstruction
  â†’ Useful for debugging session issues in both Console and Telegram
```

## Threat Model

### T1: Synthetic Tool Results Influence Claude Behavior
- **Risk:** `RepairOrphanedToolUseBlocks` injects synthetic `tool_result` blocks. If these contain non-error content, Claude might use them as facts.
- **Mitigation:** Synthetic results MUST always have `is_error = true` and content = "Session was interrupted before tool execution completed". Already enforced in current code â€” verify in tests.

### T2: Memory Flush Prompt Injection
- **Risk:** Pre-compaction flush sends conversation content to Claude for extraction. If conversation contains injected instructions, Claude might write malicious content to MEMORY.md.
- **Mitigation:** Wrap conversation content in `<untrusted_content>` tags (existing pattern). MEMORY.md content is included in system prompt but treated as advisory, not instructional.

### T3: Tool Result Pruning Hides Errors
- **Risk:** Pruning old tool results removes error context that Claude might need for follow-up debugging.
- **Mitigation:** Only prune results older than N turns (default: 6). Error results (is_error=true) are pruned with message: "[Previous tool error truncated â€” {X} chars. Original error occurred {N} turns ago.]" â€” preserves error awareness.

### T4: Bootstrap Truncation Removes Security Content
- **Risk:** If AGENTS.md or other bootstrap files are truncated, security instructions might be cut.
- **Mitigation:** Layer 2 (Security Instructions) is hardcoded in `GetSecurityInstructions()` â€” it is NEVER loaded from files and cannot be truncated. Only Layer 1 (core identity from AGENTS.md) and Layer 5 (MEMORY.md) are subject to caps.

### T5: Retry Amplification Attack
- **Risk:** An attacker with control over the network could force repeated retries, amplifying API costs.
- **Mitigation:** Max 3 retries with exponential backoff. After 3 failures, propagate the exception. Jitter prevents synchronized retries across sessions.

### T6: Compaction Event Spoofing in JSONL
- **Risk:** A tampered JSONL file could contain fake compaction events.
- **Mitigation:** Compaction events are informational only â€” they don't affect message reconstruction. `ReconstructMessagesAsync()` skips them entirely.

## Configuration

New settings in `appsettings.json` (all optional with sensible defaults):

```jsonc
{
  "Agent": {
    // Existing settings...
    "RetryMaxAttempts": 3,           // Max retry attempts for rate limits
    "RetryInitialDelayMs": 1000,     // Initial backoff delay (ms)
    "RetryMaxDelayMs": 30000,        // Maximum backoff delay (ms)
    "PruneToolResultsAfterTurns": 6, // Prune tool results older than N turns
    "PruneToolResultMinChars": 1000, // Only prune results larger than this
    "MaxBootstrapCharsPerFile": 20000,   // Max chars per bootstrap file
    "MaxBootstrapTotalChars": 150000,    // Max total chars for all bootstrap files
    "EnablePreCompactionFlush": true     // Enable memory flush before compaction
  }
}
```

## Dependencies on Existing Code

| Component | File | What v0.4.5 Changes |
|-----------|------|---------------------|
| `SessionStore` | `src/Krutaka.Memory/SessionStore.cs` | Fix `RepairOrphanedToolUseBlocks`, add post-repair validation, add compaction event type |
| `AgentOrchestrator` | `src/Krutaka.Core/AgentOrchestrator.cs` | Wrap `CompactIfNeededAsync` in try-catch, add tool result pruning before API calls |
| `ClaudeClientWrapper` | `src/Krutaka.AI/ClaudeClientWrapper.cs` | Add retry/backoff for rate limit exceptions |
| `SystemPromptBuilder` | `src/Krutaka.Core/SystemPromptBuilder.cs` | Add Layer 3c (directory context), add bootstrap file caps |
| `ContextCompactor` | `src/Krutaka.Core/ContextCompactor.cs` | Add pre-compaction memory flush |
| `Program.cs` | `src/Krutaka.Console/Program.cs` | Add error recovery for `AnthropicBadRequestException` |
| `ToolOptions` | `src/Krutaka.Tools/ToolOptions.cs` | Add new configuration properties |

## Sub-Issue Overview

| # | Title | Phase | Type |
|---|-------|-------|------|
| #181 | Fix orphaned tool_use session resume crash | B: Bugs | Bug Fix |
| #182 | Add retry/backoff for Anthropic API rate limits | B: Bugs | Bug Fix |
| #183 | Add error recovery in main loop for API exceptions | B: Bugs | Bug Fix |
| #184 | Add directory awareness to system prompt | C: Prompt | Enhancement |
| #185 | Add bootstrap file size caps to system prompt | C: Prompt | Enhancement |
| #186 | Add pre-compaction memory flush to MEMORY.md | D: Context | Enhancement |
| #187 | Add tool result pruning for older conversation turns | D: Context | Enhancement |
| #188 | Add compaction events to JSONL session files | D: Context | Enhancement |
| #189 | Adversarial tests for session resilience and API hardening | E: Test | Testing |
| #190 | v0.4.5 release documentation and verification | E: Release | Documentation |

## Acceptance Criteria (Epic Level)

- [x] All existing 1,765 tests continue to pass (2 skipped â€” zero new failures)
- [x] New tests bring total to 1,917 (+152 from v0.4.5)
- [x] Console mode: Resuming a session with orphaned tool_use blocks no longer crashes
- [x] Console mode: Rate limit (429) during agentic loop retries with backoff, does not crash
- [x] Console mode: `AnthropicBadRequestException` in main loop offers recovery, does not crash
- [x] Claude knows the working directory, ceiling directory, and auto-grant patterns
- [x] Large bootstrap files truncated with marker, security instructions never truncated
- [x] Pre-compaction flush writes key context to MEMORY.md before summarization
- [x] Tool results older than 6 turns are pruned in API calls (not in JSONL)
- [x] Compaction events recorded in JSONL for debugging
- [x] Telegram mode backward-compatible (same improvements apply)
- [x] All documentation updated to reflect v0.4.5 changes
- [x] CHANGELOG.md updated with v0.4.5 entry
