# Krutaka v0.4.6 — Project Structure, Code Quality & v0.5.0 Prerequisites

> **Version:** v0.4.6
> **Status:** ✅ Complete
> **Completed:** 2026-02-20 — 2,051 tests passing (2 skipped), 2,053 total
> **Predecessor:** v0.4.5 (✅ Complete — 1,917 tests passing, 2 skipped)
> **Successor:** v0.5.0 (Autonomous Agent Mode)

---

## Table of Contents

- [Executive Summary](#executive-summary)
- [Problem Statement](#problem-statement)
- [Goals and Non-Goals](#goals-and-non-goals)
- [Architecture Design](#architecture-design)
  - [Current State (v0.4.5)](#current-state-v045)
  - [Target State (v0.4.6)](#target-state-v046)
  - [Project Directory Specifications](#project-directory-specifications)
  - [Per-Project README Standard](#per-project-readme-standard)
  - [Test Project Mirroring](#test-project-mirroring)
  - [v0.5.0 Prerequisite Interfaces](#v050-prerequisite-interfaces)
- [Security Analysis](#security-analysis)
  - [Restructuring Safety Guarantees](#restructuring-safety-guarantees)
  - [What MUST NOT Change](#what-must-not-change)
  - [Threat Model: Zero New Attack Surface](#threat-model-zero-new-attack-surface)
  - [Risk: Accidental Behavioral Change](#risk-accidental-behavioral-change)
- [Implementation Roadmap](#implementation-roadmap)
  - [Phase Summary](#phase-summary)
  - [Issue Dependency Graph](#issue-dependency-graph)
  - [Issue Summary Table](#issue-summary-table)
- [Testing Strategy](#testing-strategy)
- [Restructuring Rules (CRITICAL)](#restructuring-rules-critical)
- [Rollback Plan](#rollback-plan)
- [Risks and Mitigations](#risks-and-mitigations)
- [Success Criteria](#success-criteria)
- [Related Documents](#related-documents)

---

## Executive Summary

v0.4.6 is a **housekeeping and preparation** release. It contains **zero user-facing feature changes**. Its purpose is to:

1. **Restructure all 14 projects** (7 source + 7 test) from flat file layouts into logical subdirectories
2. **Add per-project README files** so coding agents and contributors can navigate the codebase
3. **Fill missing test coverage** for SessionManager, SessionFactory, and DI registration
4. **Resolve medium-priority pending tasks** deferred from v0.4.0 and v0.4.5
5. **Define v0.5.0 prerequisite type stubs** so the next version can focus on behavior

This release is critical because v0.5.0 (Autonomous Agent Mode) will be the most significant behavioral change since v0.1.0. The codebase must be well-organized, well-tested, and well-documented before that work begins.

---

## Problem Statement

### Current Limitation (v0.4.5)

In v0.4.5, **all `.cs` files sit flat in each project root** with no subdirectories:

```
src/Krutaka.Core/
├── AccessDecision.cs
├── AccessLevel.cs
├── AgentConfiguration.cs
├── AgentEvent.cs
├── AgentOrchestrator.cs       # 71KB file
├── AssemblyInfo.cs
├── AuditEvent.cs
├── CommandApprovalCache.cs
├── CommandApprovalRequiredException.cs
├── CommandDecision.cs
├── ... (50+ more .cs files)
├── TelegramUserRole.cs
└── ToolBase.cs
```

**Consequences:**

1. **Navigation difficulty** — Finding `ISessionFactory` among 50+ flat files requires searching, not browsing
2. **Copilot agent confusion** — Coding agents cannot infer file purpose from directory context alone
3. **Contributor onboarding friction** — New contributors cannot understand project organization from file tree
4. **Category mixing** — Interfaces, records, enums, implementations all intermixed at the same level
5. **No project-level documentation** — No README explaining what each project is responsible for

### Missing Test Coverage

- **SessionManager**: Zero dedicated tests for lifecycle (create, suspend, resume, terminate, idle, eviction, budget)
- **SessionFactory**: Zero dedicated tests for per-session isolation guarantees
- **DI Registration**: Zero dedicated tests verifying service resolution and singleton behavior

### Pending Tasks

From `docs/status/PENDING-TASKS.md`:
- Bootstrap file truncation logging (Medium priority)
- Production deployment guide (Medium priority)
- Troubleshooting guide (Medium priority)
- ADR-014 for tool result pruning (Low priority)

---

## Goals and Non-Goals

### Goals

| # | Goal | Measurable Outcome |
|---|---|---|
| G1 | Restructure all 7 source projects | Every project has logical subdirectories, zero flat `.cs` files (except documented exceptions) |
| G2 | Add per-project READMEs | 7 README.md files, each with purpose, responsibilities, directory layout, dependencies |
| G3 | Restructure all 7 test projects | Test files mirror source project subdirectory layout |
| G4 | SessionManager test coverage | ~40 new tests covering lifecycle, concurrency, budget |
| G5 | SessionFactory test coverage | ~20 new tests covering isolation guarantees |
| G6 | DI registration test coverage | ~20 new tests covering service resolution |
| G7 | Bootstrap truncation logging | INFO-level log when files truncated |
| G8 | Production deployment guide | `docs/guides/PRODUCTION-DEPLOYMENT.md` |
| G9 | Troubleshooting guide | `docs/guides/TROUBLESHOOTING.md` |
| G10 | ADR-014 | Tool result pruning decision documented |
| G11 | v0.5.0 prerequisite interfaces | `AutonomyLevel`, `TaskBudget`, `IGitCheckpointService`, `IBehaviorAnomalyDetector` |
| G12 | Forward-looking roadmap | `docs/roadmap/ROADMAP.md` covering v0.5.0 through v1.3.0+ |
| G13 | Zero regressions | All 1,917 existing tests pass unchanged |

### Non-Goals

| # | Non-Goal | Reason |
|---|---|---|
| NG1 | Namespace changes | C# does not enforce namespace-to-directory mapping; changing namespaces would break all tests and references |
| NG2 | Logic or behavioral changes | This is a housekeeping release — zero feature changes |
| NG3 | New CLI commands | Deferred to v0.5.0 |
| NG4 | Telegram feature changes | No Telegram modifications |
| NG5 | Tool implementation changes | All tools consumed as-is |
| NG6 | Implementing v0.5.0 features | Only type stubs defined, no implementations |

---

## Architecture Design

### Current State (v0.4.5)

```text
src/
├── Krutaka.Core/          # 50+ flat .cs files, no subdirectories
├── Krutaka.Tools/         # 20+ flat .cs files, no subdirectories
├── Krutaka.Memory/        # 10+ flat .cs files, no subdirectories
├── Krutaka.Skills/        # 5+ flat .cs files, no subdirectories
├── Krutaka.AI/            # 3+ flat .cs files, no subdirectories
├── Krutaka.Telegram/      # 20+ flat .cs files, no subdirectories
└── Krutaka.Console/       # 10+ flat .cs files, no subdirectories

tests/
├── Krutaka.Core.Tests/    # Flat test files
├── Krutaka.Tools.Tests/   # Flat test files
├── Krutaka.Memory.Tests/  # Flat test files
├── Krutaka.Skills.Tests/  # Flat test files
├── Krutaka.AI.Tests/      # Flat test files
├── Krutaka.Telegram.Tests/# Flat test files
└── Krutaka.Console.Tests/ # Flat test files
```

### Target State (v0.4.6)

```text
src/
├── Krutaka.Core/
│   ├── Abstractions/       # All interfaces
│   ├── Models/             # Records, enums, DTOs
│   ├── Orchestration/      # AgentOrchestrator, ContextCompactor
│   ├── Prompt/             # SystemPromptBuilder
│   ├── Session/            # ManagedSession, CommandApprovalCache
│   ├── Correlation/        # CorrelationContext
│   ├── Security/           # Exception types
│   └── README.md
├── Krutaka.Tools/
│   ├── FileTools/          # ReadFile, WriteFile, EditFile, ListFiles, SearchFiles
│   ├── CommandTools/       # RunCommandTool
│   ├── Policies/           # CommandPolicy, CommandRiskClassifier, GraduatedCommandPolicy
│   ├── Access/             # AccessPolicyEngine, SessionAccessStore, GlobPatternValidator, PathResolver
│   ├── Security/           # SafeFileOperations, SecurityPolicy
│   ├── Configuration/      # ToolOptions, CommandPolicyOptions, CommandTierConfigValidator
│   ├── DI/                 # ServiceExtensions
│   ├── Session/            # SessionFactory, SessionManager
│   └── README.md
├── Krutaka.Telegram/
│   ├── Auth/               # TelegramAuthGuard
│   ├── Commands/           # TelegramCommandRouter, TelegramInputSanitizer
│   ├── Streaming/          # TelegramResponseStreamer
│   ├── Approval/           # TelegramApprovalHandler, CallbackDataSigner
│   ├── Session/            # TelegramSessionBridge
│   ├── Files/              # TelegramFileHandler
│   ├── Health/             # TelegramHealthMonitor
│   ├── Infrastructure/     # TelegramBotService, PollingLockFile, ServiceExtensions
│   ├── Configuration/      # (if separate config files exist)
│   └── README.md
├── Krutaka.Console/
│   ├── UI/                 # ConsoleUI, MarkdownRenderer, ApprovalHandler
│   ├── Setup/              # SetupWizard, SecretsProvider
│   ├── Logging/            # AuditLogger
│   ├── Configuration/      # HostModeConfigurator (if exists)
│   ├── Program.cs          # Entry point stays at root
���   └── README.md
├── Krutaka.Memory/
│   ├── Storage/            # SqliteMemoryStore, MemoryFileService
│   ├── Tools/              # MemoryStoreTool, MemorySearchTool
│   ├── Session/            # SessionStore
│   ├── Logging/            # DailyLogService
│   ├── Chunking/           # TextChunker
│   ├── Configuration/      # MemoryOptions
│   ├── DI/                 # ServiceExtensions
│   └── README.md
├── Krutaka.Skills/
│   ├── Loading/            # SkillLoader
│   ├── Registry/           # SkillRegistry
│   ├── Configuration/      # SkillOptions
│   ├── DI/                 # ServiceExtensions
│   └── README.md
└── Krutaka.AI/
    ├── Client/             # ClaudeClientWrapper
    ├── DI/                 # ServiceExtensions
    └── README.md
```

**Note:** The exact file-to-directory mapping should be determined during each issue's execution by examining the actual file contents and responsibilities. The structures above are guidelines — the executing agent should use best judgment for files that don't clearly fit.

### Per-Project README Standard

Each `README.md` should contain:

```markdown
# Krutaka.{ProjectName}

## Purpose
One paragraph describing what this project does.

## Dependencies
- NuGet packages (if any)
- Project references (which other Krutaka projects it depends on)

## Responsibilities
Bulleted list of what this project is responsible for.

## Directory Layout

| Directory | Description | Key Files |
|-----------|-------------|-----------|
| Abstractions/ | Interface definitions | ITool.cs, IClaudeClient.cs, ... |
| Models/ | Records, enums, DTOs | AgentEvent.cs, AccessLevel.cs, ... |
| ... | ... | ... |

## Used By
Which projects depend on this project.

## Notes
Any important notes (e.g., "This project has zero NuGet dependencies" or "Security-critical — changes require careful review").
```

### Test Project Mirroring

Test project subdirectories should mirror source project subdirectories:

```
src/Krutaka.Core/Orchestration/AgentOrchestrator.cs
  → tests/Krutaka.Core.Tests/Orchestration/AgentOrchestratorTests.cs

src/Krutaka.Tools/Access/AccessPolicyEngine.cs
  → tests/Krutaka.Tools.Tests/Access/AccessPolicyEngineTests.cs
```

Files that test multiple source files across categories should go in the subdirectory of their primary test subject. Adversarial test files can remain at the test project root or go in an `Adversarial/` subdirectory.

### v0.5.0 Prerequisite Interfaces

Type stubs to be defined (interfaces only, no implementations):

```csharp
// Autonomy levels
public enum AutonomyLevel
{
    Supervised = 0,     // v0.1.0–v0.4.x default
    Guided = 1,         // Safe auto-approved, moderate prompted
    SemiAutonomous = 2, // Safe+Moderate auto, elevated prompted
    Autonomous = 3      // All within policy, only dangerous blocked
}

// Task budget model
public record TaskBudget(
    int MaxClaudeTokens = 200_000,
    int MaxToolCalls = 100,
    int MaxFilesModified = 20,
    int MaxProcessesSpawned = 10);

public enum BudgetDimension { Tokens, ToolCalls, FilesModified, ProcessesSpawned }

public interface ITaskBudgetTracker
{
    bool TryConsume(BudgetDimension dimension, int amount);
    TaskBudgetSnapshot GetSnapshot();
    bool IsExhausted { get; }
}

// Git checkpoint service
public record CheckpointInfo(string CheckpointId, string Message, DateTime CreatedAt, int FilesModified);

public interface IGitCheckpointService
{
    Task<string> CreateCheckpointAsync(string message, CancellationToken ct);
    Task RollbackToCheckpointAsync(string checkpointId, CancellationToken ct);
    Task<IReadOnlyList<CheckpointInfo>> ListCheckpointsAsync(CancellationToken ct);
}

// Behavior anomaly detection
public enum AnomalySeverity { None, Low, Medium, High }
public record AnomalyAssessment(bool IsAnomalous, string? Reason, AnomalySeverity Severity);
public record AgentBehaviorSnapshot(/* tool call frequency, repeated failures, etc. */);

public interface IBehaviorAnomalyDetector
{
    Task<AnomalyAssessment> AssessAsync(AgentBehaviorSnapshot snapshot, CancellationToken ct);
}
```

---

## Security Analysis

### Restructuring Safety Guarantees

v0.4.6 introduces **zero new attack surface**. Every change is either:
- **File move** — moving a `.cs` file from one directory to another within the same project
- **Documentation** — markdown files only
- **Type stubs** — interface/record definitions with no implementation
- **Tests** — test code only

### What MUST NOT Change

| # | Invariant | Enforcement |
|---|---|---|
| S1 | No namespace changes | Code review. Namespaces stay as-is regardless of directory location. |
| S2 | No logic changes | Code review. File contents identical before and after move. |
| S3 | No behavioral changes | All 1,917 tests pass with zero modifications to test code (except test file moves). |
| S4 | No security boundary changes | All v0.1.0–v0.4.5 immutable boundaries remain. |
| S5 | No DI registration changes | Services resolve identically before and after restructuring. |
| S6 | No configuration changes | `appsettings.json` untouched. |

### Threat Model: Zero New Attack Surface

```text
v0.4.5 Attack Surface:           v0.4.6 Changes:
├── Local console input           (unchanged)
├── File system                   (unchanged)
├── Child processes               (unchanged)
├── Claude API                    (unchanged)
├── Telegram Bot API              (unchanged)
├── Multiple concurrent sessions  (unchanged)
├── Inline keyboard callbacks     (unchanged)
├── File upload/download          (unchanged)
├── Health monitoring             (unchanged)
└── (no new surfaces)             ← v0.4.6 adds NOTHING
```

### Risk: Accidental Behavioral Change

| Risk | Likelihood | Impact | Mitigation |
|---|---|---|---|
| File move breaks `csproj` explicit includes | Low | High | Modern SDK-style `.csproj` uses wildcard includes — file moves within project are automatic |
| Namespace mismatch after move | Zero | High | Rule: DO NOT change namespaces. C# does not enforce namespace-to-directory mapping. |
| `InternalsVisibleTo` broken | Low | Medium | Verify assembly names unchanged. They are defined in `.csproj`, not file location. |
| Test discovery fails | Low | Medium | Run `dotnet test` after every file move. xUnit discovers by assembly, not path. |
| Git history lost for moved files | Low | Low | Use `git mv` for moves to preserve history. Alternatively, accept shallow history. |

---

## Implementation Roadmap

### Phase Summary

| Phase | Focus | Issues | Est. New Tests |
|-------|-------|--------|----------------|
| A | Documentation & Instructions | #203, #204 | 0 |
| B | Source Project Restructuring | #205–#211 | 0 |
| C | Test Project Restructuring | #212 | 0 |
| D | Missing Test Coverage | #213, #214 | ~80 |
| E | Pending Task Resolution | #215, #216 | ~8 |
| F | v0.5.0 Prerequisite Interfaces | #217, #218 | ~30 |
| G | Testing & Release | #219, #220 | ~10 |
| **Total** | | **18 issues** | **~128 new tests** |

### Issue Dependency Graph

```
Phase A (no dependencies):
  #203 (Copilot Instructions + AGENTS.md)
  #204 (Roadmap Document)

Phase B (Source Restructuring — sequential within phase):
  #205 (Krutaka.Core)          ← #203
  #206 (Krutaka.Tools)         ← #205
  #207 (Krutaka.Memory)        ← #205
  #208 (Krutaka.Skills)        ← #205
  #209 (Krutaka.AI)            ← #205
  #210 (Krutaka.Telegram)      ← #205
  #211 (Krutaka.Console)       ← #205

Phase C (Test Restructuring):
  #212 (All Test Projects)     ← #205–#211

Phase D (Missing Tests):
  #213 (SessionManager Tests)  ← #212
  #214 (SessionFactory Tests)  ← #212

Phase E (Pending Tasks):
  #215 (Truncation Logging)    ← #205
  #216 (Guides)                ← #203

Phase F (v0.5.0 Prereqs):
  #217 (Autonomy + Budget)     ← #205
  #218 (Checkpoint + Anomaly)  ← #217

Phase G (Release):
  #219 (Regression Tests)      ← ALL
  #220 (Release Docs)          ← ALL
```

### Issue Summary Table

| # | Title | Phase | Depends On | Primary Area | Est. Tests |
|---|---|---|---|---|---|
| 202 | [EPIC] v0.4.6 | Epic | — | — | — |
| 203 | Copilot instructions + AGENTS.md | A | — | .github/, AGENTS.md | 0 |
| 204 | Roadmap document | A | — | docs/roadmap/ | 0 |
| 205 | Restructure Krutaka.Core | B | 203 | src/Krutaka.Core/ | 0 |
| 206 | Restructure Krutaka.Tools | B | 205 | src/Krutaka.Tools/ | 0 |
| 207 | Restructure Krutaka.Memory | B | 205 | src/Krutaka.Memory/ | 0 |
| 208 | Restructure Krutaka.Skills | B | 205 | src/Krutaka.Skills/ | 0 |
| 209 | Restructure Krutaka.AI | B | 205 | src/Krutaka.AI/ | 0 |
| 210 | Restructure Krutaka.Telegram | B | 205 | src/Krutaka.Telegram/ | 0 |
| 211 | Restructure Krutaka.Console | B | 205 | src/Krutaka.Console/ | 0 |
| 212 | Restructure test projects | C | 205–211 | tests/ | 0 |
| 213 | SessionManager lifecycle tests | D | 212 | tests/ | ~40 |
| 214 | SessionFactory + DI tests | D | 212 | tests/ | ~40 |
| 215 | Truncation logging + ADR-014 | E | 205 | Krutaka.Core, docs/ | ~8 |
| 216 | Deployment + troubleshooting guides | E | 203 | docs/guides/ | 0 |
| 217 | Autonomy + budget type stubs | F | 205 | Krutaka.Core | ~15 |
| 218 | Checkpoint + anomaly type stubs | F | 217 | Krutaka.Core | ~15 |
| 219 | Regression verification | G | ALL | — | ~10 |
| 220 | Release documentation | G | ALL | docs/, CHANGELOG | 0 |

---

## Testing Strategy

### Test Distribution

| Category | Est. Count | Test Project |
|---|---|---|
| SessionManager lifecycle | ~40 | Krutaka.Tools.Tests or Core.Tests |
| SessionFactory isolation | ~20 | Krutaka.Tools.Tests or Core.Tests |
| DI registration verification | ~20 | Krutaka.Tools.Tests |
| Bootstrap truncation logging | ~8 | Krutaka.Core.Tests |
| v0.5.0 type stubs | ~30 | Krutaka.Core.Tests |
| Regression verification | ~10 | Multiple |
| **Total new** | **~128** | |
| **Previous (v0.4.5)** | **1,917 (2 skipped)** | |
| **Target total** | **~2,045+** | |

---

## Restructuring Rules (CRITICAL)

These rules apply to ALL restructuring issues (#205–#212):

1. **File moves ONLY** — do NOT change any file contents
2. **Do NOT change namespace declarations** — C# does not enforce namespace-to-directory mapping
3. **Do NOT rename any files**
4. **`.csproj` stays at project root** — MSBuild convention
5. **`AssemblyInfo.cs` stays at project root** — if present
6. **`packages.lock.json` stays at project root** — if present
7. **`Program.cs` stays at project root** — .NET convention for executable projects
8. **Create subdirectories only if they contain 2+ files** — avoid single-file directories
9. **Use `git mv` when possible** to preserve file history
10. **Run `dotnet build && dotnet test` after EVERY file move** — verify zero regressions
11. **If any test fails after a file move, REVERT the move** — file moves should NEVER cause test failures

---

## Rollback Plan

If v0.4.6 introduces issues:

1. **Per-issue rollback**: Each restructuring issue is independent. Revert the specific issue's commit.
2. **Full revert**: v0.4.6 is on `develop` branch. `main` remains at v0.4.5 until release merge.
3. **Zero behavioral risk**: Since no logic changes, rollback is purely cosmetic (move files back).
4. **Test verification**: Run `dotnet test` after any revert to confirm all 1,917 tests pass.

---

## Risks and Mitigations

| Risk | Likelihood | Impact | Mitigation |
|---|---|---|---|
| File move breaks build | Low | High | SDK-style `.csproj` uses wildcard includes. Run `dotnet build` after every move. |
| Namespace confusion | Zero | N/A | Rule: DO NOT change namespaces. |
| Missing file in git | Low | Medium | Use `git mv`. Verify `git status` after every move. |
| Test discovery failure | Low | Medium | xUnit discovers by assembly, not file path. Run `dotnet test` after every move. |
| `InternalsVisibleTo` broken | Low | Medium | Assembly names defined in `.csproj`, not file location. |
| Copilot agent moves files incorrectly | Medium | Low | Each issue has explicit directory mapping. Verify in code review. |
| Scope creep into logic changes | Medium | High | Issue instructions explicitly forbid content changes. Only file moves and markdown. |

---

## Success Criteria

- [x] All 1,917 pre-existing tests pass with zero new failures (2 skipped)
- [x] ~128 new tests pass, bringing total to ~2,045+ (actual: 2,051 passing, 2 skipped, 2,053 total)
- [x] Every source project has a `README.md` with standard sections
- [x] Zero `.cs` files flat in source project roots (except `Program.cs`, `AssemblyInfo.cs`, `ToolBase.cs`)
- [x] Test projects mirror source project directory layouts
- [x] No namespace changes anywhere in the codebase
- [x] Console mode behavior identical to v0.4.5
- [x] Telegram mode behavior identical to v0.4.5
- [x] Bootstrap file truncation logged at INFO level
- [x] `docs/guides/PRODUCTION-DEPLOYMENT.md` complete
- [x] `docs/guides/TROUBLESHOOTING.md` complete
- [x] ADR-014 in `docs/architecture/DECISIONS.md`
- [x] v0.5.0 prerequisite interfaces defined with XML docs
- [x] `docs/roadmap/ROADMAP.md` created
- [x] `CHANGELOG.md` updated with v0.4.6 entry
- [x] All documentation accurate and consistent

---

## Related Documents

- `docs/versions/v0.4.5.md` — predecessor version spec
- `docs/roadmap/ROADMAP.md` — forward-looking roadmap (created in Issue #204)
- `docs/architecture/OVERVIEW.md` — component architecture
- `docs/architecture/MULTI-SESSION.md` — multi-session isolation (SessionManager/SessionFactory context)
- `docs/architecture/SECURITY.md` — security model (unchanged)
- `docs/architecture/DECISIONS.md` — ADRs (ADR-014 added in Issue #215)
- `docs/status/PROGRESS.md` — progress tracker
- `docs/status/PENDING-TASKS.md` — pending tasks being resolved
- `CHANGELOG.md` — version history
- `AGENTS.md` — agent instructions
- `.github/copilot-instructions.md` — Copilot instructions
- `.github/instructions/csharp.instructions.md` — C# coding conventions
- `release-lifecycle.txt` — release workflow
